name: Deploy Monitoring Stack to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy monitoring to"
        required: true
        default: "experimental"
        type: choice
        options:
          - staging
          - production
          - experimental
      action:
        description: "Action to perform"
        required: true
        default: "install"
        type: choice
        options:
          - install
          - upgrade
          - uninstall

permissions:
  id-token: write
  contents: read
  deployments: write

env:
  CLUSTER_NAME: ${{ vars.CLUSTER_NAME || 'vanillatstodo-cluster' }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  APP_NAME: ${{ vars.APP_NAME || 'vanillatstodo' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'experimental' }}
  ACTION: ${{ github.event.inputs.action || 'install' }}

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'experimental' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get IAM Role ARN
        id: iam_role_arn
        run: |
          # Try to get role ARN from IAM Terraform state
          cd devops/terraform/04_iam
          terraform init -reconfigure \
            -backend-config="bucket=${{ vars.BUCKET_NAME || 'vanillatstodo-terraform-state' }}" \
            -backend-config="key=${{ env.ENVIRONMENT }}/iam/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" >/dev/null 2>&1 || true
          
          # Check if IAM resources exist and get role ARN
          if terraform output -raw github_actions_role_arn 2>/dev/null; then
            ROLE_ARN=$(terraform output -raw github_actions_role_arn)
            echo "github_actions_role_arn=${ROLE_ARN}" >> $GITHUB_OUTPUT
            echo "‚úÖ Found IAM role ARN: ${ROLE_ARN}"
          else
            # Fallback to secret if IAM state not available
            ROLE_ARN="${{ secrets.AWS_ROLE_ARN }}"
            echo "github_actions_role_arn=${ROLE_ARN}" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Using fallback role ARN from secrets"
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.iam_role_arn.outputs.github_actions_role_arn }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.12.3"

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --role-arn ${{ steps.iam_role_arn.outputs.github_actions_role_arn }}

      - name: Verify Cluster Connection
        run: |
          echo "üîç Verifying cluster connection..."
          kubectl cluster-info
          kubectl get nodes
          
          echo ""
          echo "üîç Checking cluster resources..."
          kubectl top nodes || echo "‚ùå Metrics server not available"
          kubectl get nodes -o custom-columns=NAME:.metadata.name,STATUS:.status.conditions[-1].type,CPU:.status.allocatable.cpu,MEMORY:.status.allocatable.memory

      - name: Add Helm Repositories
        run: |
          echo "üì¶ Adding Helm repositories..."
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Create Monitoring Namespace
        run: |
          echo "üèóÔ∏è Creating monitoring namespace..."
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

      - name: Inspect Storage and Events
        if: env.ACTION == 'install' || env.ACTION == 'upgrade'
        run: |
          echo "üß∞ Inspecting storage classes and default class..."
          kubectl get storageclass
          kubectl get storageclass -o jsonpath='{range .items[?(@.metadata.annotations.storageclass\.kubernetes\.io/is-default-class=="true")]}* { .metadata.name }{"\n"}{end}' || true
          
          echo "üîç Checking EBS CSI driver status..."
          kubectl get pods -n kube-system | grep ebs-csi || echo "‚ùå EBS CSI driver not found"
          kubectl get csidriver ebs.csi.aws.com || echo "‚ùå EBS CSI driver not registered"
          
          echo "üßæ Recent events in monitoring namespace (if exists)"
          kubectl get events -n monitoring --sort-by=.lastTimestamp | tail -n 100 || true

      - name: Install/Upgrade Monitoring Stack
        if: env.ACTION == 'install' || env.ACTION == 'upgrade'
        run: |
          echo "üöÄ ${{ env.ACTION }}ing monitoring stack..."
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Release name: ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}"
          echo "Values file: ./devops/helm-chart-monitoring/values-${{ env.ENVIRONMENT }}.yaml"

          # Download dependencies
          cd devops/helm-chart-monitoring
          helm dependency update

          # Install or upgrade with debug and non-fatal exit to allow diagnostics
          echo "üîç Installing (with debug) and capturing failure details if any..."
          # Detect working StorageClass (prefer gp3, fallback to gp2, then any available)
          DEFAULT_SC=$(kubectl get storageclass -o jsonpath='{range .items[?(@.metadata.annotations.storageclass\.kubernetes\.io/is-default-class=="true")]}{.metadata.name}{"\n"}{end}')
          if [ -z "$DEFAULT_SC" ]; then
            # Try gp3 first (newer, better performance)
            if kubectl get storageclass gp3 >/dev/null 2>&1; then
              DEFAULT_SC="gp3"
              echo "‚úÖ Using gp3 StorageClass"
            # Fallback to gp2
            elif kubectl get storageclass gp2 >/dev/null 2>&1; then
              DEFAULT_SC="gp2"
              echo "‚ö†Ô∏è Using gp2 StorageClass (gp3 not available)"
            # Last resort: use any available
            else
              DEFAULT_SC=$(kubectl get storageclass -o jsonpath='{.items[0].metadata.name}')
              echo "‚ö†Ô∏è Using first available StorageClass: $DEFAULT_SC"
            fi
          else
            echo "‚úÖ Default StorageClass detected: $DEFAULT_SC"
          fi
          set +e
          helm upgrade --install ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }} . \
            --namespace monitoring \
            -f values-${{ env.ENVIRONMENT }}.yaml \
            --wait --timeout=1200s \
            --debug \
            --set global.project=${{ env.APP_NAME }} \
            --set global.cluster_name=${{ env.CLUSTER_NAME }} \
            --set global.environment=${{ env.ENVIRONMENT }} \
            --set prometheus-stack.grafana.adminPassword=${{ secrets.GRAFANA_PWD }} \
            --set prometheus-stack.grafana.persistence.storageClassName=$DEFAULT_SC \
            --set prometheus-stack.prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName=$DEFAULT_SC \
            --set prometheus-stack.prometheus.prometheusSpec.resources.limits.cpu=500m \
            --set prometheus-stack.prometheus.prometheusSpec.resources.limits.memory=1Gi \
            --set prometheus-stack.prometheus.prometheusSpec.resources.requests.cpu=200m \
            --set prometheus-stack.prometheus.prometheusSpec.resources.requests.memory=512Mi \
            --set prometheus-stack.grafana.resources.limits.cpu=200m \
            --set prometheus-stack.grafana.resources.limits.memory=512Mi \
            --set prometheus-stack.grafana.resources.requests.cpu=100m \
            --set prometheus-stack.grafana.resources.requests.memory=256Mi
          HELM_EXIT_CODE=$?
          set -e

          if [ "$HELM_EXIT_CODE" -ne 0 ]; then
            echo "‚ùå Helm reported failure (exit $HELM_EXIT_CODE). Collecting diagnostics..."
            echo "--- Helm Release Status ---"
            helm status ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }} --namespace monitoring || true
            echo "--- Helm Get All ---"
            helm get all ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }} --namespace monitoring || true
            echo "--- Kubernetes: Pods ---"
            kubectl get pods -n monitoring -o wide || true
            echo "--- Kubernetes: Describe Pods (problematic) ---"
            for p in $(kubectl get pods -n monitoring --no-headers | awk '$3!="Running" || $4>0 {print $1}'); do
              echo "Describing $p"; kubectl describe pod $p -n monitoring || true; done
            echo "--- Kubernetes: Events ---"
            kubectl get events -n monitoring --sort-by=.lastTimestamp | tail -n 200 || true
            echo "--- Kubernetes: PVCs ---"
            kubectl get pvc -n monitoring -o wide || true
            echo "--- Kubernetes: Pending Pods with scheduling details ---"
            kubectl get pod -n monitoring -o json | jq -r '.items[] | select(.status.phase=="Pending") | .metadata.name' | while read name; do
              echo "Pod: $name"; kubectl describe pod -n monitoring "$name" | sed -n '/Events:/,$p' || true; done
            exit $HELM_EXIT_CODE
          fi

      - name: Uninstall Monitoring Stack
        if: env.ACTION == 'uninstall'
        run: |
          echo "üóëÔ∏è Uninstalling monitoring stack..."
          helm uninstall ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }} \
            --namespace monitoring || echo "Release not found"

      - name: Wait for Monitoring Stack
        if: env.ACTION == 'install' || env.ACTION == 'upgrade'
        run: |
          echo "‚è≥ Waiting for monitoring stack to be ready..."

          # Wait for Prometheus
          kubectl rollout status deployment/${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-kube-prom-prometheus \
            --namespace monitoring --timeout=10m || echo "Prometheus deployment not found"

          # Wait for Grafana
          kubectl rollout status deployment/${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-grafana \
            --namespace monitoring --timeout=10m

          echo "‚úÖ Monitoring stack is ready!"

      - name: Get Monitoring Access Information
        if: env.ACTION == 'install' || env.ACTION == 'upgrade'
        id: monitoring_info
        run: |
          echo "üìä Getting monitoring access information..."

          # Get Grafana service details
          GRAFANA_SERVICE_TYPE=$(kubectl get svc ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-grafana \
            --namespace monitoring -o jsonpath='{.spec.type}')

          echo "GRAFANA_SERVICE_TYPE=${GRAFANA_SERVICE_TYPE}" >> $GITHUB_ENV

          if [ "$GRAFANA_SERVICE_TYPE" = "LoadBalancer" ]; then
            echo "‚è≥ Waiting for Grafana LoadBalancer..."
            for i in {1..20}; do
              GRAFANA_URL=$(kubectl get svc ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-grafana \
                --namespace monitoring -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
              if [ -n "$GRAFANA_URL" ]; then
                echo "GRAFANA_URL=http://${GRAFANA_URL}" >> $GITHUB_ENV
                echo "‚úÖ Grafana URL: http://${GRAFANA_URL}"
                break
              fi
              echo "‚è≥ Waiting for Grafana external IP... (${i}/20)"
              sleep 15
            done
          else
            echo "GRAFANA_URL=kubectl port-forward" >> $GITHUB_ENV
            echo "‚ÑπÔ∏è Grafana is accessible via: kubectl port-forward svc/${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-grafana 3000:80 --namespace monitoring"
          fi

          # Get Prometheus URL
          echo "PROMETHEUS_URL=kubectl port-forward" >> $GITHUB_ENV
          echo "‚ÑπÔ∏è Prometheus is accessible via: kubectl port-forward svc/${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-kube-prom-prometheus 9090:9090 --namespace monitoring"

      - name: Verify Monitoring Health
        if: env.ACTION == 'install' || env.ACTION == 'upgrade'
        run: |
          echo "üîç Checking monitoring stack health..."

          echo "üìä Monitoring Pods:"
          kubectl get pods -n monitoring

          echo ""
          echo "üìä Monitoring Services:"
          kubectl get svc -n monitoring

          echo ""
          echo "üìä Monitoring PVCs:"
          kubectl get pvc -n monitoring

      - name: Deployment Summary
        if: always()
        run: |
          echo "### üìä Monitoring Stack Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "| --------- | ------ | ------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ env.ACTION }} | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | ${{ env.CLUSTER_NAME }} | EKS |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Name | ${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }} | Helm Release |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | monitoring | Kubernetes |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.ACTION }}" != "uninstall" ]; then
            echo "| Grafana Access | ${{ env.GRAFANA_URL || 'Port Forward' }} | Web UI |" >> $GITHUB_STEP_SUMMARY
            echo "| Prometheus Access | ${{ env.PROMETHEUS_URL || 'Port Forward' }} | Web UI |" >> $GITHUB_STEP_SUMMARY
            echo "| Default Login | admin / admin123 | Change in Production! |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Access Instructions" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.GRAFANA_URL }}" != "kubectl port-forward" ] && [ -n "${{ env.GRAFANA_URL }}" ]; then
            echo "**Grafana URL:** ${{ env.GRAFANA_URL }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Grafana (Port Forward):** \`kubectl port-forward svc/${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-grafana 3000:80 --namespace monitoring\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Prometheus (Port Forward):** \`kubectl port-forward svc/${{ env.APP_NAME }}-monitoring-${{ env.ENVIRONMENT }}-prometheus-stack-kube-prom-prometheus 9090:9090 --namespace monitoring\`" >> $GITHUB_STEP_SUMMARY
          echo "**Default Credentials:** admin / admin123" >> $GITHUB_STEP_SUMMARY
